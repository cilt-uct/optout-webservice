{% include 'header.html' %}
    <aside id="nav-side">
        <ul>
            <li><a href="#top" ref="top">Top</a></li>
        {% for l in list %}
            <li><a href="#{{l}}" ref="{{l}}">{{l}}</a></li>
        {% endfor %}
        </ul>
    </aside>
    <a name="top" class="anchor"></a>
    <div class="container post">
        <div class="row post-body">
            <div class="col-md-12 post-title">
                <span style="color: #ccc;font-size: 0.8em;">Hi {{authenticated.z.result.0.name}},</span>
                <h3><span style="color: #5caad2;">Lecture Recording</span> Admin</h3>
                <br/>
                <div>
                     <!--p>{{authenticated|json_encode()}}</p-->
                     <p>{{workflow|json_encode()}}</p>
                    
    <!--div class="wrapper">
        <div class="content">
            <h1 id="date" class="date"></h1>
            <h3 id="time" class="time"></h3>
        </div>
    </div-->

                </div>
                <br/>
                <div class="departments" id="departments">
                    {% if departments.success %}
                        {% set newTitle = '0' %}
                        {% for dept in departments.result %}
                        <div>
                            {% set curTitle = dept.dept|split('')|first %}
                            {% if (curTitle != newTitle) %}
                                {% set newTitle = curTitle %}
                                <a name="{{newTitle}}" class="anchor"></a>
                            {% endif %}                        
                            <div class="row no-gutters dept-title">
                                <div class="col-sm-6">
                                    {% if dept.eligble_courses > 0 %}
                                    <h5><a href="https://srvslscet001.uct.ac.za/optout/view/{{dept.hash}}" target="_blank">{{dept.dept}}&nbsp;&nbsp;<small>{{dept.name}}</small></a></h5>
                                    {% else %}
                                    <h5 style="margin:0.4em;">{{dept.dept}}&nbsp;&nbsp;<small>{{dept.name}}</small></h5>
                                    {% endif %}
                                </div>
                                <div class="col-sm-2" style="padding-top:0.6em;">
                                    <label>Active</label>
                                    <div class="switch">    
                                        <input type="checkbox" id="chk_use_{{dept.dept}}" data-dept="{{dept.dept}}" data-hash="{{dept.hash}}" {% if (dept.use_dept == '1') %}checked{% endif %} /><label id="toggle_use_{{dept.dept}}" for="chk_use_{{dept.dept}}">Toggle</label>
                                    </div>
                                </div>
                                <div class="col-sm-4" style="padding-top:0.6em;">
                                    <label>Opted Out</label>
                                    <label class="right" id="chk_opt_{{dept.dept}}_date">
                                        {% if dept.updated_by|length > 1 %}{{dept.updated_by}}<br/>{{dept.updated_at|date("g:ia \o\n l jS F Y")}}{% endif %}
                                    </label>
                                    <div class="switch">    
                                        <input type="checkbox" id="chk_opt_{{dept.dept}}" data-dept="{{dept.dept}}" data-hash="{{dept.hash}}" {% if dept.is_optout %}checked{% endif %}/><label id="toggle_opt_{{dept.dept}}" for="chk_opt_{{dept.dept}}">Toggle</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row no-gutters dept-details">
                                <div class="col-sm-8">
                                    <h6>Contact Details</h6>
                                    <div class="form-group row">
                                        <label for="inp_{{dept.dept}}_firstname" class="col-sm-3 col-form-label">Firstname</label>
                                        <div class="col-sm-8">
                                            <input type="text" class="form-control" 
                                                    id="inp_{{dept.dept}}_firstname" data-type="dept" data-field="hodFirstname" data-dept="{{dept.dept}}" data-hash="{{dept.hash}}" 
                                                    placeholder="Firstname" data-old="{{dept.firstname}}" value="{{dept.firstname}}"/>
                                            <span class="loader">
                                                <span></span>
                                                <span></span>
                                                <span></span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label for="inp_{{dept.dept}}_lastname" class="col-sm-3 col-form-label">Lastname</label>
                                        <div class="col-sm-8">
                                            <input type="text" class="form-control" 
                                                    id="inp_{{dept.dept}}_lastname" data-type="dept" data-field="hodLastname" data-dept="{{dept.dept}}" data-hash="{{dept.hash}}" 
                                                    placeholder="Lastname" data-old="{{dept.lastname}}" value="{{dept.lastname}}"/>
                                            <span class="loader">
                                                <span></span>
                                                <span></span>
                                                <span></span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label for="inp_{{dept.dept}}_mail" class="col-sm-3 col-form-label">E-mail</label>
                                        <div class="col-sm-8">
                                            <input type="text" class="form-control" 
                                                    id="inp_{{dept.dept}}_mail" data-type="dept" data-field="hodMail" data-dept="{{dept.dept}}" data-hash="{{dept.hash}}" 
                                                    placeholder="E-mail" data-old="{{dept.email|lower}}" value="{{dept.email|lower}}"/>
                                            <span class="loader">
                                                <span></span>
                                                <span></span>
                                                <span></span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <label for="inp_{{dept.dept}}_alt" class="col-sm-3 col-form-label">Alternative E-mail</label>
                                        <div class="col-sm-8" id="{{dept.dept}}_alt_mail_container" style="position: relative;">
                                            {% set alt_mails = dept.alt_email|split(',') %}
                                            <input type="hidden" id="{{dept.dept}}_alt" name="{{dept.dept}}_alt" value="{{dept.alt_email}}"/>
                                            <input type="hidden" id="inp_{{dept.dept}}_alt_mails" name="inp_{{dept.dept}}_alt_mails" value="{{alt_mails|length}}"/>
                                            {% for mail in alt_mails %}
                                            <div class="multi" id="{{dept.dept}}_alt_{{ loop.index }}">
                                                <a href="#" class="{% if loop.index == 1 %}success{% else %}danger{% endif %}" rel="{{dept.dept}}" data-dept="{{dept.dept}}" data-hash="{{dept.hash}}" data-index="{{ loop.index }}">
                                                    <i class="fa {% if loop.index == 1 %}fa-plus{% else %}fa-minus{% endif %}" aria-hidden="true"></i>
                                                </a>
                                                <input type="text" class="form-control" 
                                                        id="inp_{{dept.dept}}_alt_{{ loop.index }}" data-type="dept" data-field="altMail" data-dept="{{dept.dept}}" data-hash="{{dept.hash}}"
                                                        data-index="{{ loop.index }}"
                                                        placeholder="E-mail" data-old="{{mail}}" value="{{mail|lower}}"/>                                                
                                                <span class="loader">
                                                    <span></span>
                                                    <span></span>
                                                    <span></span>
                                                </span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>                                    
                                </div>
                                <div class="col-sm-4">
                                    <h6>&nbsp;</h6>
                                    <table>
                                        <tbody>
                                            <tr>
                                                <td class="text-right"><strong>Eligble Courses:</strong></td>
                                                <td>{{dept.eligble_courses}}</td>
                                            </tr>
                                            <tr>
                                                <td colspan="2"><hr/></td>
                                            </tr>
                                            <tr>
                                                <td class="text-right"><strong>Course Mails:</strong>&nbsp;&nbsp;&nbsp;Sent</td>
                                                <td>{{dept.mail_sent}}</td>
                                            </tr>   
                                            <tr>
                                                <td class="text-right">To Send</td>
                                                <td>{{dept.mail_unsent}}</td>
                                            </tr>
                                            <tr>
                                                <td class="text-right">Error</td>
                                                <td>{{dept.mail_err}}</td>
                                            </tr>
                                         
                                        </tbody>
                                    </table>
                                    <br/>
                                    {% if dept.eligble_courses > 0 %}
                                    <div class="text-center">
                                        <button class="btn btn-outline-success btn-sm" style="width:60%" id="btn_view_{{dept.dept}}" data-rel="{{dept.dept}}" data-hash="{{dept.hash}}">View Courses</button>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row no-gutters justify-content-end dept-courses" id="{{dept.dept}}_courses">
                                <div class="col-10" id="{{dept.dept}}_courses_html">
                                    
                                    
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                </div>
                {% else %}
                {{departments|json_encode()}}
                {% endif %}
            </div>
        </div>
    </div>
    <script src="{{ asset('assets/js/jquery.min.js') }}"></script>
    <script src="{{ asset('assets/js/tmpl.js') }}"></script>
    <script src="{{ asset('assets/js/moment.min.js') }}"></script>    
    <script src="{{ asset('assets/bootstrap/js/bootstrap.min.js') }}"></script>
    <script>
        var changeTimer = false, field = null, div = null,
            email_regex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/i;

        $(function() {

            // view courses
            $('#departments .dept-details').on('click','button.btn-sm', function(event) {
                var btn = $(this);
                div = $('#'+ btn.data('rel') +'_courses_html');
                console.log(btn.data('rel') +' '+ btn.data('hash'));
               
                if (btn.hasClass('btn-outline-info')) {
                    $('#'+ btn.data('rel') +'_courses').hide();
                    btn.removeClass('btn-outline-info').addClass('btn-outline-success').html('View Courses');
                } else {
                    btn.removeClass('btn-outline-success').addClass('btn-outline-info').html('Hide Courses');
                    $('#'+ btn.data('rel') +'_courses_html').html(tmpl('tmpl-courses-loading',{}));
                    $('#'+ btn.data('rel') +'_courses').show();

                    $.ajax({
                        headers: {"x-entity-hash": btn.data('hash'), "x-entity-courses": '1'},
                        url: "/optout/api/v0/dept/"+ btn.data('rel'),
                        method: 'GET',
                        dataType: 'json'
                    }).done(function(data) {
                        console.log(data)
                        $('#'+ data.dept +'_courses_html').html(tmpl('tmpl-courses', data));
                    }).fail(function(xhr) {
                        div.html(tmpl('tmpl-courses-error',{}));
                    });
                }
            });

            $('#departments').on('click','.course-details button.btn-sm', function(event) {
                var btn = $(this);
                div = $('#'+ btn.data('rel') +'_timetable');
                console.log(btn.data('rel') +' '+ btn.data('year'));

                if (btn.hasClass('btn-outline-info')) {
                    div.hide();
                    btn.removeClass('btn-outline-info').addClass('btn-outline-success').html('View Timetable');
                } else {
                    btn.removeClass('btn-outline-success').addClass('btn-outline-info').html('Hide Timetable');
                    div.html(tmpl('tmpl-timetable-loading',{})).show();

                    $.ajax({
                        url: "/optout/api/v0/timetable/"+ btn.data('rel') +"/"+ btn.data('year'),
                        method: 'GET',
                        dataType: 'json'
                    }).done(function(data) {
                        console.log(data);
                        div.html(tmpl('tmpl-course-timetable', data));
                    }).fail(function(xhr) {
                        div.html(tmpl('tmpl-timetable-error',{}));
                    });
                }
            });
    
            // saving department active
            $('.dept-title input[id*="chk_use_"]').on('change', function(event) {
                var chk = $(this);
                console.log(chk.attr('id') +' '+ chk.data('dept') +' '+ chk.data('hash') +' '+ chk.is(':checked'));

                d = [{  "dept": chk.data('dept'),
                        "changes": [{
                                "field": 'active', 
                                "from": chk.is(':checked') ? '0' : '1', 
                                "to": chk.is(':checked') ? '1' : '0'
                            }]
                        }];
                console.log(JSON.stringify(d));
                $.ajax({
                    headers: {"x-entity-hash": chk.data('hash')},
                    url: "/optout/api/v0/dept/" + chk.data('dept'),
                    method: 'patch',
                    data: JSON.stringify(d)
                }).done(function() {
                    console.log('done');
                }).fail(function(xhr) {
                    
                    console.log(xhr.responseText);
                });
            });

            // saving department opt-out
            $('.dept-title input[id*="chk_opt_"]').on('change', function(event) {
                var chk = $(this),
                    dt = $('#'+ $(this).attr('id') +'_date');
                console.log(chk.attr('id') +' '+ chk.data('dept') +' '+ chk.data('hash') +' '+ chk.is(':checked'));
                
                $.ajax({
                    headers: {"x-entity-hash": chk.data('hash')},
                    url: "/optout/api/v0/dept/"+ chk.data('dept'),
                    method: 'PUT',
                    data: '{"status": '+ (chk.is(':checked') ? '1':'0') +'}',
                    dataType: 'json'
                }).done(function(data) {
                    if (data.success) {
                        dt.html(data.user +'<br/>'+ moment(data.date).calendar());
                    } else {
                        console.log(data);
                        alert('error opting out department');
                    }
                }).fail(function(xhr) {
                    console.log(xhr);
                    alert('error opting out department');
                });
            });

            // saving course opt-out
            $('#departments').on('change', '.course-title input[id*="chk_opt_"]', function(event) {
                var chk = $(this),
                    dt = $('#'+ $(this).attr('id') +'_date');
                console.log(chk.attr('id') +' '+ chk.data('course') +' '+ chk.data('hash') +' '+ chk.is(':checked'));
                
                $.ajax({
                    headers: {"x-entity-hash": chk.data('hash')},
                    url: "/optout/api/v0/course/"+ chk.data('course'),
                    method: 'PUT',
                    data: '{"status": '+ (chk.is(':checked') ? '1':'0') +'}',
                    dataType: 'json'
                }).done(function(data) {
                    if (data.success) {
                        dt.html(data.user +' '+ moment(data.date).calendar());
                    } else {
                        console.log(data);
                        alert('error opting out course');
                    }
                }).fail(function(xhr) {
                    console.log(xhr);
                    alert('error opting out course');
                });
            });

            $('#departments').on('click','.multi a',function(event){
                event.preventDefault();
                var dept = $(this).attr('rel'),
                    cnt = parseInt($('#inp_'+ dept +'_alt_mails').val(), 10),
                    idx = parseInt($(this).data('index'), 10);
                
                console.log($('#inp_'+ dept +'_alt_mails').val() + " "+ idx);

                if ($(this).hasClass('success')) {

                    $('#inp_'+ dept +'_alt_mails').val(cnt + 1);
                    $('#'+ dept +'_alt_mail_container').append(tmpl('tmpl-dept-altMail', 
                                    {index: cnt+1, dept: $(this).data('dept'), hash: $(this).data('hash')}));
                } else {
                    $('#inp_'+ dept +'_alt_'+ idx).parent().remove();
                    $('#inp_'+ dept +'_alt_1').trigger('change');
                }
            });

            $('#departments').on('focusin','input[type=text]',function(event){
                $(this).parent().removeClass('done err updating');
            });
            
            $('#departments').on('change','input[type=text]',function(event){
                if (changeTimer !== false) clearTimeout(changeTimer);
                var valid = true, d = [], dept = $(this).data('dept');

                field = $(this);
                field.parent()
                            .removeClass('done err updating')
                            .removeAttr('data-errortext');

                //console.log(field.attr('id') +' '+ field.data('dept') +' '+ field.data('hash') +' '+ field.data('type') +' '+ field.data('field'));

                if (field.data('field') != 'altMail') {
                    d = [{  "changes": [{
                                "field": field.data('field'),
                                "from": field.data('old'), 
                                "to": field.val()
                            }]
                        }];

                    if ((field.data('field') === 'hodMail') || (field.data('field') === 'convenorEmail')) {
                        if (!email_regex.test(field.val())) { 
                            mailValidationError(field);
                            valid = false;
                        }

                        d[0]['changes'][0]['to'] = d[0]['changes'][0]['to'].toLowerCase();
                        d[0]['changes'][0]['from'] = d[0]['changes'][0]['from'].toLowerCase();
                    }
                
                } else {
                    
                    var idx = field.data('index'),
                        cnt = $('#inp_'+field.data('dept')+'_alt_mails').val(),
                        new_val = [];

                    for (var i = 1; i <= cnt; i++) {
                        var f = $('#inp_'+ field.data('dept') +'_alt_'+ i);
                        if (f.length > 0) {
                            if (f.val() != '') {
                                if(!email_regex.test(f.val())){ 
                                    mailValidationError(f);
                                    valid = false;
                                } else {
                                    new_val.push(f.val().toLowerCase());
                                }
                            }
                        }
                    }

                    $('#'+ dept +'_alt').data('to', new_val.join(','));
                    d = [{  "changes": [{
                                "field": field.data('field'),
                                "from": $('#'+ dept +'_alt').val(), 
                                "to": new_val.join(',')
                            }]
                        }];
                }
                
                d[0][ field.data('type') ] = (field.data('type') == 'dept' ? field.data('dept') : field.data('course'));

                if (valid) {
                    field.parent().addClass('updating');

                    console.log(d);
                    
                    $.ajax({
                        headers: {"x-entity-hash": field.data('hash')},
                        url: "/optout/api/v0/dept/"+ field.data('dept'),
                        method: 'patch',
                        data: JSON.stringify(d)
                    }).done(function() {
                        updateSuccess(field);
                    }).fail(function(xhr) {
                        if (xhr.status === 409 && xhr.responseJSON) {
                            console.log(xhr.responseJSON);
                        }

                        updateError(field, xhr);
                    }).always(function() {
                        field.parent().removeClass('updating');
                    });                    
                }
            });

            function updateSuccess(field) {
                field
                    .data('old', field.val())
                    .parent()
                    .addClass('done');

                if (field.data('field') == 'altMail') {
                    var dept = field.data('dept');
                    $('#'+ dept +'_alt').val( $('#'+ dept +'_alt').data('to') );
                }
                setTimeout(function() {
                    field
                        .parent()
                        .removeClass('done');
                }, 5000);
            }

            function updateError(field, serverResponse) {
                field
                    .parent()
                    .addClass('err')
                    .attr('data-errortext', 'Already updated. Please refresh to view the latest changes.');
            }

            function mailValidationError(field, serverResponse) {
                field
                    .parent()
                    .addClass('err')
                    .attr('data-errortext', 'Please enter a valid e-mail address.');
            }
        });
    </script>
    {{ source('admin_templates.html') }}
    {% include 'footer.html' %}
    <!-- https://www.pexels.com/photo/auditorium-benches-chairs-class-207691/ -->
</body>
</html>
